<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{Make wasp data}
-->

First, you need to:
[Install the OS X command line tools](http://www.rstudio.com/ide/docs/packages/prerequisites) (for a C++ compiler)

```{r, eval=FALSE}
install.packages("Rcpp", type = "source")
install.packages("devtools")
devtools::install_github("jackets", "seananderson")
devtools::install_github("dplyr")
```

Then load the jackets and data.table packages:

```{r}
library(jackets)
library(data.table)
```

To read and save the `.rda` files in Dropbox, first set your working
directory to the `wasp-trips/data` folder before running this code:

```{r, eval=FALSE}
load("wasps1.rda")
wasps1$uid_group <- wasps1$uid
wasps1_dt <- dplyr::group_by(as.data.table(wasps1), uid_group)
rm(wasps1)
wasps1_trips <- dplyr::do(wasps1_dt, function(x) get_wasp_trips(x,
    diff_address_home = -1, diff_address_away = 1,
    correct_time_stamps = FALSE, print_progress = TRUE))
rm(wasps1_dt)
wasps1_trips <- do.call("rbind", wasps1_trips)
wasps1_trips <- as.data.frame(wasps1_trips)

load("wasps2.rda")
wasps2$uid_group <- wasps2$uid
wasps2_dt <- dplyr::group_by(as.data.table(wasps2), uid_group)
rm(wasps2)
wasps2_trips <- dplyr::do(wasps2_dt, function(x) get_wasp_trips(x,
    diff_address_home = 2, diff_address_away = -2,
    correct_time_stamps = TRUE, print_progress = TRUE))
rm(wasps2_dt)
wasps2_trips <- do.call("rbind", wasps2_trips)
wasps2_trips <- as.data.frame(wasps2_trips)

wasps1_trips$group <- 1
wasps2_trips$group <- 2
wasp <- rbind(wasps1_trips, wasps2_trips)
rm(wasps1_trips, wasps2_trips)

row.names(wasp) <- NULL

save(wasp, file = "wasp.rda")
```

We can now load the `wasp.rda` file from within the package with:

```{r}
load("wasp.rda")
```

Calculate hour of day:

```{r}
wasp$time_trunc <- as.POSIXct(trunc(wasp$time, "days"))
wasp$hour_of_day <- as.numeric(difftime(wasp$time, wasp$time_trunc,
    units = "hours"))
```

Now merge in the tag-caste data:

```{r}
load("cohorts_1.rda")
cohorts_1$caste <- as.character(cohorts_1$caste)
cohorts_1$date_tagged <- as.character(cohorts_1$date_tagged)
cohorts_2 <- read.csv("cohorts_2.csv", stringsAsFactors = FALSE)
cohorts_1$group <- 1
cohorts_2$group <- 2
cohorts <- rbind(cohorts_1, cohorts_2)
cohorts$date_tagged <- strptime(cohorts$date_tagged, format = "%Y-%m-%d")
cohorts$date_tagged <- as.POSIXct(cohorts$date_tagged)

# Create a transformed uid column that matches the tag format:
wasp <- transform(wasp, tag = paste0(substr(uid, 1, 2), substr(uid, 4, 5)))
wasp$uid <- NULL

library(plyr)
wasp <- join(wasp, cohorts, by = c("tag", "group"))
```

And create some summary data:

```{r}
wasp_summary <- ddply(wasp, c("trips", "tag", "caste", "group"), summarize,
  mean_trip = mean(time_diff/60/60, na.rm = TRUE), median_trip =
  median(time_diff/60/60, na.rm = TRUE), l_quant =
  quantile(time_diff/60/60, 0.25, na.rm = TRUE), u_quant =
  quantile(time_diff/60/60, 0.75, na.rm = TRUE))

wasp_summary <- transform(wasp_summary, ordered_tag = reorder(tag,
    -median_trip))
save(wasp_summary, file = "wasp_summary.rda")
```

Look at some plots:

```{r, warning=FALSE, message=FALSE}
library(ggplot2)
ggplot(wasp, aes(hour_of_day)) + geom_histogram(aes(fill = trips)) +
facet_grid(caste~group, scales = "free_y")
```

```{r, warning=FALSE, message=FALSE}
ggplot(wasp, aes(time_diff)) + geom_histogram() +
facet_grid(caste~trips, scales = "free_y") + scale_x_log10()
```

```{r, warning=FALSE, fig.width=10}
ggplot(wasp_summary, aes(ordered_tag, median_trip, colour = trips, pch
    = caste)) + geom_pointrange(aes(ymin =
  l_quant, ymax = u_quant)) + scale_y_log10() +
  scale_shape_manual(values=c(21, 19)) + scale_linetype_manual(values
    = c(2, 1)) + theme(axis.text.x=element_text(angle=90, size = 8)) +
  xlab("") + ylab("Median trip length (hours)") + facet_wrap(~group, nrow = 2, scales = "free_x")
```
